<!DOCTYPE html><html><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link rel="preload" href="/jonsadka-blog/component---src-layouts-index-js-9bcc628ad035ecfaff6c.js" as="script"/><link rel="preload" href="/jonsadka-blog/component---src-templates-blog-post-js-e2550c15e4ac39512926.js" as="script"/><link rel="preload" href="/jonsadka-blog/path---how-to-generate-time-series-week-over-week-year-over-year-aggregations-in-mongodb-using-unix-epoch-timestamps-tutorial-and-example-ed6ac1f4955033856db7.js" as="script"/><link rel="preload" href="/jonsadka-blog/app-6ebf03875e0f1bc56b17.js" as="script"/><link rel="preload" href="/jonsadka-blog/commons-101651d16a9337c0a50f.js" as="script"/><title data-react-helmet="true">Jon Sadka - How to generate time series aggregations in MongoDB using Unix / Epoch timestamps (week over week, year over year, etc. tutorial and example)</title><meta data-react-helmet="true" name="description" content="Sample"/><meta data-react-helmet="true" name="keywords" content="sample, something"/><style id="gatsby-inlined-css">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:112.5%/1.45em georgia,serif;box-sizing:border-box;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{color:rgba(0,0,0,.8);font-family:georgia,serif;font-weight:400;word-wrap:break-word;-webkit-font-kerning:normal;font-kerning:normal;-ms-font-feature-settings:"kern","liga","clig","calt";-webkit-font-feature-settings:"kern","liga","clig","calt";font-feature-settings:"kern","liga","clig","calt","kern"}img{max-width:100%;margin:0 0 1.45rem;padding:0}h1{font-size:2.25rem}h1,h2{margin:0 0 1.45rem;padding:0;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{margin:0 0 1.45rem;padding:0;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{margin:0 0 1.45rem;padding:0;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h6{font-size:.78405rem}hgroup{margin:0 0 1.45rem;padding:0}ol,ul{margin:0 0 1.45rem 1.45rem;padding:0;list-style-position:outside;list-style-image:none}dd,dl,figure,p{margin:0 0 1.45rem;padding:0}pre{padding:0;font-size:.85rem;line-height:1.42;background:rgba(0,0,0,.04);border-radius:3px;overflow:auto;word-wrap:normal;padding:1.45rem}pre,table{margin:0 0 1.45rem}table{padding:0;font-size:1rem;line-height:1.45rem;border-collapse:collapse;width:100%}fieldset{margin:0 0 1.45rem;padding:0}blockquote{margin:0 1.45rem 1.45rem;padding:0}form,iframe,noscript{margin:0 0 1.45rem;padding:0}hr{margin:0 0 calc(1.45rem - 1px);padding:0;background:rgba(0,0,0,.2);border:none;height:1px}address{margin:0 0 1.45rem;padding:0}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-left:1.45rem;margin-bottom:.725rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:SFMono-Regular,Consolas,Roboto Mono,Droid Sans Mono,Liberation Mono,Menlo,Courier,monospace;padding:0;padding-top:.2em;padding-bottom:.2em}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{letter-spacing:-.2em;content:" "}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}</style></head><body><div id="___gatsby"><div data-reactroot="" data-reactid="1" data-react-checksum="-1707494637"><!-- react-empty: 2 --><div style="background:rebeccapurple;margin-bottom:1.45rem;" data-reactid="3"><div style="margin:0 auto;max-width:960px;padding:1.45rem 1.0875rem;" data-reactid="4"><h1 style="margin:0;" data-reactid="5"><a style="color:white;text-decoration:none;" href="/jonsadka-blog/" data-reactid="6">Jon Sadka&#x27;s Blog</a></h1></div></div><div style="margin:0 auto;max-width:960px;padding:0px 1.0875rem 1.45rem;padding-top:0;" data-reactid="7"><div class="blog-post-container" data-reactid="8"><!-- react-empty: 9 --><div class="blog-post" data-reactid="10"><h1 data-reactid="11">How to generate time series aggregations in MongoDB using Unix / Epoch timestamps (week over week, year over year, etc. tutorial and example)</h1><div class="blog-post-content" data-reactid="12"><p>ECMAScript5 introduced <code>Date.now()</code>, a method that returns the milliseconds elapsed since <code>1 January 1970 00:00:00 UTC</code> up until now as a <code>Number</code>. <code>Date.now()</code> is the fastest way to record a timestamp in JavaScript<sup><a href="https://jsperf.com/date-now-vs-new-date-gettime/11">[1]</a>, <a href="http://jsperf.com/date-now-vs-new-date-gettime/8">[2]</a></sup> and as such, usage will continue to increase as developers become educated in speed improvements.</p>
<p>While speed improvements are important, storing Unix / Epoch timestamps in MongoDB come with a quirk; MongoDB only support BSON native date objects. What this means as a developer is that the <a href="http://docs.mongodb.org/manual/reference/operator/aggregation-date">Date Aggregation Operators</a> such as <code>$dayOfWeek</code> and <code>$dayOfYear</code> are unusable natively. This poses a challenge when trying to obtain time series reports such as week over week reports, month over month reports, year over year reports, etc. There are two tricks one can use to solving this problem.</p>
<h3>Sample data</h3>
<p>For the proceeding examples, we will assume our database has a collection called <code>shipments</code> and documents that look like this:</p>
<pre><code class="language-json">// documents in the shipment collection
{
  _id : "ef0581de-7cae-4e18-8c25-e6ea36489793",
  contents : "Microsoft Glass 19",
},
{
  _id : "8b0b5ec1-f6c2-4637-a560-75d96ec6f19b",
  contents : "Apple iPhone 7",
  sentAt : 1444438552674
},
{
  _id : "2643046-92c3-4fa9-aa51-c6f3e668bde5",
  contents : "Samsung Galaxy 6 Edge+",
  sentAt : 1436684400000
},
{
  _id : "a3b673ee-17f9-4e9c-aa68-a70fac19ea10",
  contents : "Nokia 8850",
  sentAt : 920880000000
}
</code></pre>
<h3>Approach 1</h3>
<p>The first approach can be achieved by using an addition aggregation to convert the timestamp into a BSON object in memory then utilize MongoDB’s Date Aggregation Operators to obtain the desired result. Below is an example of this approach.</p>
<p>MongoDB query | MongoDB result</p>
<pre><code class="language-json">// Finds all sent shipments
db.shipments.aggregate(
  [
    { $match : { "sentAt" : { "$exists" : 1 } } }
  ]
)
</code></pre>
<p> |</p>
<pre><code class="language-json">{
  _id : "8b0b5ec1-f6c2-4637-a560-75d96ec6f19b",
  contents : "Apple iPhone 7",
  sentAt : 1444438552674
},
{
  _id : "2643046-92c3-4fa9-aa51-c6f3e668bde5",
  contents : "Samsung Galaxy 6 Edge+",
  sentAt : 1436684400000
},
{
  _id : "a3b673ee-17f9-4e9c-aa68-a70fac19ea10",
  contents : "Nokia 8850",
  sentAt : 920880000000
}
</code></pre>
<pre><code class="language-json">// Finds all sent shipments, returning the BSON timestamp
db.shipments.aggregate(
  [
    { $match : { "sentAt" : { "$exists" : 1 } } },
    { $project : { "mongoTimestamp" : {$add : [new Date(0), "$sentAt"] } } }
  ]
)
</code></pre>
<p> |</p>
<pre><code class="language-json">{
  _id : "8b0b5ec1-f6c2-4637-a560-75d96ec6f19b",
  mongoTimestamp : ISODate("2015-07-02T22:09:48.911Z")
},
{
  _id : "2643046-92c3-4fa9-aa51-c6f3e668bde5",
  mongoTimestamp : ISODate("2015-07-02T22:09:48.911Z")
},
{
  _id : "a3b673ee-17f9-4e9c-aa68-a70fac19ea10",
  mongoTimestamp : ISODate("2015-07-02T22:09:48.911Z")
}
</code></pre>
<pre><code class="language-json">// Finds all sent shipments, returning the year shipped
db.shipments.aggregate(
  [
    { $match : { "sentAt" : { "$exists" : 1 } } },
    { $project : { "mongoTimestamp" : { $add : [new Date(0), "$sentAt"] } } },
    { $project : { "year_shipped" : { $year : "$mongoTimestamp" } } }
  ]
)
</code></pre>
<p> |</p>
<pre><code class="language-json">{
  _id : "8b0b5ec1-f6c2-4637-a560-75d96ec6f19b",
  year_shipped : 2015
},
{
  _id : "2643046-92c3-4fa9-aa51-c6f3e668bde5",
  year_shipped : 2015
},
{
  _id : "a3b673ee-17f9-4e9c-aa68-a70fac19ea10",
  year_shipped : 1999
}
</code></pre>
<pre><code class="language-json">// Finds counts of all sent shipments, grouped by year
db.shipments.aggregate(
  [
    { $match : { "sentAt" : { "$exists" : 1 } } },
    { $project : { "mongoTimestamp" : { $add : [new Date(0), "$sentAt"] } } },
    { $project : { "year_shipped" : { $year : "$mongoTimestamp" } } },
    { $group : { _id : {year_shipped : "$year_shipped" } , number : { $sum : 1 } } }
  ]
)
</code></pre>
<p> |</p>
<pre><code class="language-json">{
  _id : { year_shipped : 2015 },
  number: 2
},
{
  _id : { year_shipped : 1999 },
  number: 1
}
</code></pre>
<h3>Approach 2</h3>
<p>Approach 1 above works fine and is probably the preferred method, however in many production type situations the query is stringified by a framework or application prior to submitting / sending the query. If this were true in the above example, <code>{ $add : [new Date(0), "$sentAt"] }</code> would have been converted to <code>{ $add : ["Wed Dec 31 1969 16:00:00 GMT-0800 (PST)", "$sentAt"] }</code> prior to submission, causing MongoDB to return the error message <code>"errmsg" : "exception: $add only supports numeric or date types, not String"</code>.</p>
<p>A workaround to the above problem can be had using the <code>n - (n % )</code> modulo trick. This equation allows us to round any number to the nearest interval. For example, if we had a list of numbers such as <code>105.2</code>, <code>251</code> and <code>170.1</code> and we wanted to round to the nearest hundreth, performing the above operations on each number using the interval of 100 would result in <code>100</code>, <code>200</code>, and <code>100</code>. We can extrapolate this logic and apply it to days, weeks, months, quarters, years, etc. Note, one limitation of this method is that it does not honor daylight savings time.</p>
<p>Now, let’s apply Approach 2 to the same shipments example. For reference, one year is equivalent to 31,556,908,800 milliseconds.</p>
<p>MongoDB query | MongoDB result</p>
<pre><code class="language-json">// Finds all sent shipments
db.shipments.aggregate(
  [
    { $match : { "sentAt" : { "$exists" : 1 } } }
  ]
)
</code></pre>
<p> |</p>
<pre><code class="language-json">{
  _id : "8b0b5ec1-f6c2-4637-a560-75d96ec6f19b",
  contents : "Apple iPhone 7",
  sentAt : 1444438552674
},
{
  _id : "2643046-92c3-4fa9-aa51-c6f3e668bde5",
  contents : "Samsung Galaxy 6 Edge+",
  sentAt : 1436684400000
},
{
  _id : "a3b673ee-17f9-4e9c-aa68-a70fac19ea10",
  contents : "Nokia 8850",
  sentAt : 920880000000
}
</code></pre>
<pre><code class="language-json">// Finds all sent shipments, returning the year shipped in milliseconds
db.shipments.aggregate(
  [
    { $match : { "sentAt" : { "$exists" : 1 } } },
    { $project : { "year_shipped" :
      { $subtract : ["$sentAt", {$mod : ["$sentAt", 31556908800] } ] },
    } }
  ]
)
</code></pre>
<p> |</p>
<pre><code class="language-json">{
  _id : "8b0b5ec1-f6c2-4637-a560-75d96ec6f19b",
  year_shipped : 1420060896000
},
{
  _id : "2643046-92c3-4fa9-aa51-c6f3e668bde5",
  year_shipped : 1420060896000
},
{
  _id : "a3b673ee-17f9-4e9c-aa68-a70fac19ea10",
  year_shipped : 915150355200
}
</code></pre>
<pre><code class="language-json">// Finds all shipments that have been sent and groups by year
db.shipments.aggregate(
  [
    { $match : { "sentAt" : { "$exists" : 1 } } },
    { $project : { "year_shipped" :
      { $subtract : ["$sentAt", {$mod : ["$sentAt", 31556908800] } ] },
      { $group : { _id : {year_shipped : "$year_shipped" } , number : { $sum : 1 } } }
    } }
  ]
)
</code></pre>
<p> |</p>
<pre><code class="language-json">{
  _id : { year_shipped : 1420060896000 },
  number: 2
},
{
  _id : { year_shipped : 915150355200 },
  number: 1
}
</code></pre></div></div></div></div></div></div><script id="webpack-manifest">/*<![CDATA[*/window.webpackManifest={"231608221292675":"app-6ebf03875e0f1bc56b17.js","107818501498521":"component---src-templates-blog-post-js-e2550c15e4ac39512926.js","50739212244294":"component---src-templates-tags-js-46f77b4651e0e872f739.js","162898551421021":"component---src-pages-404-js-4503918ea3a16cfcdb75.js","35783957827783":"component---src-pages-index-js-e1033c26ec43e6503da4.js","195850678278728":"component---src-pages-tags-js-878029e311c4b7e27b1e.js","60335399758886":"path----557518bd178906f8d58a.js","10171900593404":"path---choosing-the-best-numbers-in-nfl-football-squares-to-beat-your-friends-71dd690a8f6a19e224a6.js","50182333802029":"path---how-to-generate-time-series-week-over-week-year-over-year-aggregations-in-mongodb-using-unix-epoch-timestamps-tutorial-and-example-ed6ac1f4955033856db7.js","226515019055661":"path---how-to-write-data-to-the-beginning-of-a-file-with-node-javascript-tutorial-and-example-22aefb564e6e2e44d059.js","71122540562017":"path---how-apple-can-catch-up-to-google-ratings-and-yelp-reviews-overnight-eb924336f4a0900b69a7.js","61368061307467":"path---best-and-worst-times-to-take-an-uber-ca1a2a2f4255e8a87358.js","219282622727209":"path---how-to-create-adaptive-pie-charts-with-transitions-in-d-3-7bcb6afac163e5c215e6.js","27746275504635":"path---how-to-create-live-updating-and-flexible-d-3-line-charts-using-pseudo-data-814ac49acb19661fa0fd.js","176459137894972":"path---how-to-modify-filter-and-save-json-files-locally-using-jquery-316e2eeedcd35bff693f.js","28430980993147":"path---how-to-quickly-create-randomly-generated-datasets-in-javascript-with-d-3-de27b665e45a7cad19a6.js","140111421340535":"path---using-reduce-to-create-arrays-and-objects-in-javascript-cd817ad43fca6c04a3c2.js","238983728261001":"path---how-to-use-the-uber-api-to-get-pricing-data-82f59817e4c43edc61a8.js","64521555383069":"path---fight-on-the-power-of-javascript-closures-c1c5d3d67a13bdffe2ae.js","274554345536044":"path---prototypal-and-pseudoclassical-instantiation-in-javascript-0d7403c3aad990f9d66b.js","2567721212742":"path---type-coercion-in-d-3-js-63fe3fde1e13146131fa.js","224731842900174":"path---supercharge-your-falsey-conditional-statements-in-javascript-95456ddd1a7b9da44704.js","127501106087498":"path---tags-d-3-js-339ef5faed7508da74b1.js","212641908305216":"path---tags-java-script-c3008b1e4a79c09dd6d6.js","32135422922473":"path---tags-mongo-db-e929d498656e364b5dac.js","4836336648314":"path---tags-ux-ui-8096d33bb2351ce71aa3.js","155610972471906":"path---tags-api-68184236e20114c45c67.js","235634758467862":"path---tags-j-query-9fc4ad235e2dc285a51b.js","254022195166212":"path---404-a0e39f21c11f6a62c5ab.js","142629428675168":"path---index-b938dcf589aa0b165c87.js","55702396619907":"path---tags-328153fa62f2f720e118.js","178698757827068":"path---404-html-a0e39f21c11f6a62c5ab.js","114276838955818":"component---src-layouts-index-js-9bcc628ad035ecfaff6c.js"}/*]]>*/</script><script>/*<![CDATA[*/!function(e,t,r){function n(){for(;d[0]&&"loaded"==d[0][f];)c=d.shift(),c[o]=!i.parentNode.insertBefore(c,i)}for(var s,a,c,d=[],i=e.scripts[0],o="onreadystatechange",f="readyState";s=r.shift();)a=e.createElement(t),"async"in i?(a.async=!1,e.head.appendChild(a)):i[f]?(d.push(a),a[o]=n):e.write("<"+t+' src="'+s+'" defer></'+t+">"),a.src=s}(document,"script",["/jonsadka-blog/commons-101651d16a9337c0a50f.js","/jonsadka-blog/app-6ebf03875e0f1bc56b17.js","/jonsadka-blog/path---how-to-generate-time-series-week-over-week-year-over-year-aggregations-in-mongodb-using-unix-epoch-timestamps-tutorial-and-example-ed6ac1f4955033856db7.js","/jonsadka-blog/component---src-templates-blog-post-js-e2550c15e4ac39512926.js","/jonsadka-blog/component---src-layouts-index-js-9bcc628ad035ecfaff6c.js"])/*]]>*/</script></body></html>